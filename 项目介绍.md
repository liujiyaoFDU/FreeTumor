# FreeTumor 项目详细介绍

## 一、项目简介

### 1.1 这个项目是干什么的?

**FreeTumor** 是一个基于生成式AI(Generative AI)的医学影像肿瘤合成框架,专门用于在CT影像中大规模生成逼真的肿瘤图像。

**主要功能:**
- 在CT扫描图像上自动生成逼真的合成肿瘤
- 支持多种肿瘤类型(肝脏肿瘤、胰腺肿瘤、肾脏肿瘤、肺部病灶等)
- 支持不同大小的肿瘤生成(微小、小型、中型、大型)
- 通过"图灵测试"筛选高质量的合成肿瘤

**解决了什么问题:**
- **数据稀缺问题**: 医学影像标注需要大量专业放射科医生的工作,成本高昂且耗时
- **训练数据不足**: AI肿瘤识别模型缺乏足够的训练样本
- **肿瘤样本多样性不足**: 真实肿瘤数据集中某些类型的肿瘤样本较少

**应用场景:**
- 医学影像AI模型的训练数据增强
- 肿瘤分割和检测算法的性能提升
- 放射科医生的辅助诊断系统训练
- 医学影像数据集扩充

**研究成果:**
- 论文发表在顶级期刊 **Nature Communications**
- 13位认证放射科医生进行视觉图灵测试,仅能以51.1%的敏感度和60.8%的准确度区分真假肿瘤(接近随机猜测)
- 证明合成肿瘤的高度真实性

### 1.2 使用的主要技术栈

**编程语言:**
- Python (主要语言)

**深度学习框架:**
- PyTorch (深度学习核心框架)
- MONAI (医学影像专用深度学习库)

**核心技术:**
- **生成对抗网络 (GAN)**:
  - Generator (生成器): 使用3D UNet生成肿瘤差异图
  - Discriminator (判别器): 区分真实肿瘤和合成肿瘤
- **Swin UNETR**: 基于Transformer的3D医学影像分割模型
- **滑动窗口推理 (Sliding Window Inference)**: 处理大尺寸3D医学影像
- **自监督学习**: 支持使用VoCo预训练模型

**关键技术模块:**
- 椭球体生成与弹性变形 (elasticdeform)
- 纹理生成 (基于高斯滤波的随机纹理)
- 图像混合 (Mixup数据增强)
- 质量控制 (基线分割模型筛选)

---

## 二、文件和目录结构

### 2.1 项目整体结构

```
FreeTumor/
├── FreeTumor-Abdomen/        # 腹部肿瘤合成 (肝、胰腺、肾)
├── FreeTumor-Chest/          # 胸部肿瘤合成 (肺部病灶)
├── FreeTumor-leaderboard/    # 排行榜任务解决方案
├── README.md                 # 项目说明文档
└── LICENSE                   # 许可证文件
```

### 2.2 核心目录详解 (以 FreeTumor-Chest 为例)

```
FreeTumor-Chest/
├── jsons/                    # 数据集配置文件
│   ├── TCIAcovid19.json     # COVID-19 数据集配置
│   ├── stoic21.json         # STOIC21 数据集配置
│   ├── LIDC.json            # 肺结节数据集配置
│   └── ...
│
├── models/                   # 神经网络模型定义
│   ├── TumorGAN.py          # 核心GAN模型 (生成器+判别器+分割器)
│   ├── Unet.py              # 3D UNet模型定义
│   └── __init__.py
│
├── utils/                    # 工具函数和数据处理
│   ├── TumorGenerated/      # 肿瘤生成核心模块
│   │   ├── TumorGenerated.py   # 肿瘤生成数据增强类
│   │   └── utils.py            # 几何形状生成、纹理生成、肿瘤合成
│   ├── data_utils.py        # 数据加载器
│   ├── utils.py             # 通用工具函数
│   └── mixup.py             # Mixup数据增强
│
├── optimizers/              # 优化器和学习率调度器
│   └── lr_scheduler.py      # 余弦退火学习率调度
│
├── Syn_train.py             # 肿瘤合成训练入口 (训练GAN)
├── Syn_trainer.py           # 肿瘤合成训练器
├── Free_train.py            # 分割模型训练入口
├── Free_trainer.py          # 分割模型训练器
├── Syn_covid.sh             # GAN训练脚本
└── Free_covid.sh            # 分割训练脚本
```

### 2.3 主要文件职责

| 文件 | 职责 |
|------|------|
| `Syn_train.py` | **合成训练入口** - 训练肿瘤生成器GAN模型 |
| `Free_train.py` | **分割训练入口** - 使用合成肿瘤训练分割模型 |
| `TumorGAN.py` | **核心生成模型** - 包含生成器、判别器、分割器和图灵测试 |
| `utils/TumorGenerated/utils.py` | **肿瘤合成算法** - 几何生成、纹理生成、肿瘤植入 |
| `data_utils.py` | **数据加载** - 加载CT图像和标签 |
| `mixup.py` | **数据增强** - Mixup混合增强 |

### 2.4 项目入口

**肿瘤合成训练 (第一阶段):**
```bash
# 入口: Syn_train.py
sh Syn_covid.sh  # 或 Syn_train.sh
```

**分割模型训练 (第二阶段):**
```bash
# 入口: Free_train.py
sh Free_covid.sh  # 或 Free_train.sh
```

---

## 三、核心逻辑

### 3.1 工作流程总览

FreeTumor的工作分为**两个主要阶段**:

```
阶段1: 肿瘤生成器训练 (Syn_train.py)
  ↓
训练TumorGAN生成逼真的合成肿瘤
  ↓
阶段2: 分割模型训练 (Free_train.py)
  ↓
使用生成的合成肿瘤增强训练数据
  ↓
最终得到高性能的肿瘤分割模型
```

### 3.2 关键类和函数详解

#### 3.2.1 TumorGAN 类 (`models/TumorGAN.py`)

这是整个项目的**核心模型**,包含三个子网络:

```python
class TGAN(nn.Module):
    def __init__(self, args):
        # 1. 生成器 (Generator)
        self.netG = UNet3D(input_channel=1, n_class=1)
        # 作用: 生成"差异图" (difference map),表示肿瘤与正常组织的差异

        # 2. 判别器 (Discriminator)
        self.netD = UNet3D(input_channel=1, n_class=3)
        # 作用: 区分三类 - 背景、真实肿瘤、合成肿瘤

        # 3. 分割器 (Segmentor)
        self.netSeg = SwinUNETR(...)
        # 作用: 预训练的分割模型,用于质量控制(图灵测试)
```

**关键方法:**

1. **forward() - 前向传播**
   - `mode="losses_G"`: 计算生成器损失
   - `mode="losses_D"`: 计算判别器损失
   - `mode="generate"`: 生成肿瘤用于训练

2. **Synthesis() - 肿瘤合成**
   ```python
   def Synthesis(self, image, label, difference):
       # 步骤:
       # 1. 随机选择肿瘤类型 (tiny/small/medium)
       # 2. 随机选择纹理
       # 3. 调用SynthesisTumor生成肿瘤
       # 4. 返回合成图像和标签
   ```

3. **TuringTest() - 图灵测试**
   ```python
   def TuringTest(self, ...):
       # 检查合成肿瘤是否能被分割模型识别
       # 只保留通过测试的肿瘤 (比例 > 70%)
       # 确保生成的肿瘤足够逼真
   ```

#### 3.2.2 肿瘤生成算法 (`utils/TumorGenerated/utils.py`)

**核心函数流程:**

```python
def SynthesisTumor(args, volume_scan, mask_scan, tumor_type, texture, ...):
    """
    完整的肿瘤合成流程

    输入:
    - volume_scan: CT图像
    - mask_scan: 器官掩码 (0:背景, 1:器官, 2:真实肿瘤)
    - tumor_type: 肿瘤类型 (tiny/small/medium/large/mix)
    - texture: 预定义纹理
    - difference: 生成器生成的差异图

    步骤:
    1. 调用 get_tumor() 生成肿瘤
    2. 返回合成后的图像和标签
    """
```

**关键步骤:**

```
步骤1: 生成椭球体几何形状
   ↓ (get_ellipsoid)
生成基础椭球体
   ↓
步骤2: 弹性变形
   ↓ (elasticdeform)
使形状更自然不规则
   ↓
步骤3: 随机选择位置
   ↓ (random_select)
在器官内随机选择肿瘤中心点
   ↓
步骤4: 应用纹理
   ↓ (texture blending)
使用高斯模糊的纹理图
   ↓
步骤5: 混合到原图
   ↓
abnormally = volume + geo_blur * difference * texture
   ↓
步骤6: 更新标签
   ↓
abnormally_mask[geo_mask] = 3  # 标记为合成肿瘤
```

**纹理生成:**

```python
def get_predefined_texture(shape, sigma_a, sigma_b):
    # 1. 生成随机噪声
    a = np.random.uniform(0, 1, size=shape)

    # 2. 高斯滤波平滑
    a_2 = gaussian_filter(a, sigma=sigma_a)

    # 3. 二值化采样
    b = (a > random_sample).astype(float)

    # 4. 再次高斯滤波
    b2 = gaussian_filter(b, sigma_b)

    # 5. 归一化到 [0, 1]
    return normalized_texture
```

### 3.3 数据流动

#### 3.3.1 训练阶段1: GAN训练 (Syn_train.py)

```
输入数据
  ↓
DataLoader 加载CT图像和器官掩码
  ↓
netG (生成器) 生成差异图
  ↓
Synthesis() 合成肿瘤图像
  ↓
netD (判别器) 判断真假
  ↓
netSeg (分割器) 质量控制
  ↓
TuringTest() 筛选高质量肿瘤
  ↓
计算损失并更新网络参数
  ↓
保存训练好的TumorGAN模型
```

**损失函数设计:**

1. **生成器损失 (losses_G)**:
   - 欺骗判别器: 让判别器认为合成肿瘤是真实的
   - 质量控制损失: 让分割器能够识别合成肿瘤

2. **判别器损失 (losses_D)**:
   - 正确识别真实肿瘤
   - 正确识别合成肿瘤

#### 3.3.2 训练阶段2: 分割模型训练 (Free_train.py)

```
输入数据
  ↓
DataLoader 加载CT图像和标签
  ↓
在线调用TumorGAN生成合成肿瘤
  ↓
Mixup 数据增强
  ↓
Swin UNETR 分割模型训练
  ↓
计算分割损失 (DiceCE Loss)
  ↓
验证集评估 (Dice指标)
  ↓
保存最优分割模型
```

**关键代码 (Free_trainer.py):**

```python
def train_epoch(model, loader, ..., Tgan):
    for batch_data in loader:
        image, label = batch_data["image"], batch_data["label"]

        if args.task == 'freesyn':
            # 在线生成合成肿瘤
            syn_image, syn_label = syn_data(image, label, Tgan, args)
        else:
            # 基线方法: 只用真实数据
            syn_image, syn_label = image, label

        # Mixup增强
        if args.mixup:
            syn_image, syn_label = mixup([syn_image, syn_label])

        # 前向传播
        logits = model(syn_image)
        loss = loss_func(logits, syn_label)

        # 反向传播
        loss.backward()
        optimizer.step()
```

### 3.4 各部分协作关系

```
┌─────────────────────────────────────────────────────────┐
│                     FreeTumor 系统架构                    │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌──────────┐      ┌──────────┐      ┌──────────┐      │
│  │ 生成器 G  │ ──→  │ 肿瘤合成  │ ──→  │ 判别器 D  │      │
│  │ (UNet3D) │      │ 模块      │      │ (UNet3D) │      │
│  └──────────┘      └──────────┘      └──────────┘      │
│       ↓                  ↓                  ↓            │
│  生成差异图        几何+纹理合成        真假判别          │
│                                                          │
│  ┌──────────────────────────────────────────────┐      │
│  │          分割器 (Swin UNETR)                  │      │
│  │          质量控制 + 图灵测试                  │      │
│  └──────────────────────────────────────────────┘      │
│                         ↓                                │
│              只保留高质量合成肿瘤                         │
│                                                          │
│  ┌──────────────────────────────────────────────┐      │
│  │       最终分割模型 (用合成数据增强训练)        │      │
│  └──────────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────────┘
```

---

## 四、项目亮点

### 4.1 创新点

1. **大规模无标注数据利用**
   - 可以利用大量无肿瘤标注的CT扫描数据
   - 只需要器官掩码(可由基础模型生成)即可合成肿瘤
   - 显著降低标注成本

2. **图灵测试质量控制**
   - 不是所有生成的肿瘤都被使用
   - 通过预训练分割模型筛选高质量肿瘤
   - 只保留能够"欺骗"分割模型的逼真肿瘤(通过率>70%)

3. **多尺度肿瘤生成**
   - 支持tiny, small, medium, large四种尺寸
   - 支持mix模式生成多种尺寸混合
   - 更贴近真实临床场景

4. **在线生成策略**
   - 训练时动态生成合成肿瘤(不预先生成数据集)
   - 每个epoch生成不同的肿瘤
   - 极大增加数据多样性

### 4.2 技术亮点

1. **3D医学影像处理**
   - 完整的3D卷积网络
   - 滑动窗口推理处理大尺寸图像
   - 支持分布式多GPU训练

2. **精细的纹理生成算法**
   - 基于多层高斯滤波
   - 预定义10种纹理模板
   - 随机裁剪和混合增加多样性

3. **弹性变形技术**
   - 使用elasticdeform库
   - 三个方向的随机变形
   - 生成不规则的自然形状

4. **GAN架构设计**
   - 生成器生成"差异图"而非直接生成图像
   - 判别器区分三类(背景、真实肿瘤、合成肿瘤)
   - 分割器作为额外的质量评估

### 4.3 实用价值

1. **显著提升分割性能**
   - 相比只用标注数据训练,性能大幅提升
   - 超越现有的合成方法和基础模型

2. **通过临床验证**
   - 13位认证放射科医生无法有效区分(准确率60.8%)
   - 证明合成肿瘤的临床可用性

3. **开源和可复现**
   - 完整代码开源
   - 提供预训练模型和数据集
   - 详细的使用说明

4. **广泛适用性**
   - 支持多种器官(肝、胰腺、肾、肺)
   - 可扩展到其他类型肿瘤
   - 提供了通用框架

### 4.4 有趣的设计

1. **"图灵测试"概念应用**
   - 借鉴经典的图灵测试思想
   - 用AI模型测试AI生成的质量
   - 形成闭环的质量保证机制

2. **GAN+分割器三角关系**
   ```
   生成器: 我要生成逼真的肿瘤!
      ↓
   判别器: 我要识别出假肿瘤!
      ↓
   分割器: 我来判断这个肿瘤够不够逼真!
      ↓
   只有通过所有考验的肿瘤才会被用于训练
   ```

3. **分阶段训练策略**
   - 先训练GAN生成高质量肿瘤
   - 再用合成肿瘤训练分割模型
   - 避免了端到端训练的复杂性

4. **纹理和几何分离**
   - 几何形状: 椭球+变形
   - 纹理: 高斯噪声+滤波
   - 差异图: 生成器学习
   - 三者结合产生最终肿瘤

---

## 五、使用示例

### 5.1 训练肿瘤生成器

```bash
cd FreeTumor-Chest

# 1. 准备数据集和基线分割模型
# 2. 修改Syn_covid.sh中的参数
# 3. 运行训练
sh Syn_covid.sh
```

### 5.2 训练分割模型

```bash
# 使用FreeTumor方法
sh Free_covid.sh --task freesyn --TGAN_checkpoint ./runs/logs_syn_covid/model_final.pt

# 基线方法(只用真实数据)
sh Free_covid.sh --task onlylabeled
```

### 5.3 关键参数

| 参数 | 说明 |
|------|------|
| `--data` | 数据集名称 (covid/lits/panc/kits) |
| `--task` | freesyn(FreeTumor) / onlylabeled(基线) |
| `--TGAN_checkpoint` | 生成器模型路径 |
| `--baseline_seg_dir` | 基线分割模型路径(用于质量控制) |
| `--use_ssl_pretrained` | 是否使用VoCo预训练模型 |
| `--mixup` | 是否使用Mixup增强 |

---

## 六、总结

FreeTumor是一个**创新性的医学影像数据增强框架**,通过生成式AI技术解决了医学影像领域数据稀缺的关键问题。它结合了:

- **先进的深度学习技术** (GAN, Transformer, 自监督学习)
- **精心设计的肿瘤合成算法** (几何生成、纹理合成、质量控制)
- **严格的临床验证** (放射科医生图灵测试)

为医学影像AI研究提供了强大的工具,有望推动肿瘤诊断和治疗的发展,最终提高患者生存率。

---

**相关链接:**
- 论文: https://arxiv.org/abs/2502.18519
- 代码: https://github.com/Luffy03/FreeTumor
- 模型: https://huggingface.co/Luffy503/FreeTumor
- 数据集: https://huggingface.co/datasets/Luffy503/FreeTumor
